{{define "web_scripts"}}
<script type="module" src="/static/datastar.js"></script>
<div data-signals='{"wsVersion":"","wsUpdated":false}' data-on:load="@get('/events')"></div>
<div class="msg" data-show="$wsUpdated" style="position: fixed; bottom: 16px; right: 16px; max-width: 380px;">
  <div style="margin-bottom: 8px;">Workspace updated</div>
  <button type="button" data-on:click="location.reload()">Reload</button>
</div>
<script>
(() => {
  // Keyboard-first navigation (does not interfere with form inputs).
  // - g p => projects
  // - g a => agenda
  // - g s => sync
  // - g h => home
  // - ?   => help overlay
  let awaiting = null;
  let awaitingAt = 0;
  const clearAwaiting = () => { awaiting = null; awaitingAt = 0; };

  const showHelp = () => {
    let el = document.getElementById('clarity-kb-help');
    if (!el) {
      el = document.createElement('div');
      el.id = 'clarity-kb-help';
      el.style.position = 'fixed';
      el.style.top = '16px';
      el.style.right = '16px';
      el.style.maxWidth = '380px';
      el.style.padding = '12px 14px';
      el.style.border = '1px solid rgba(127,127,127,.35)';
      el.style.borderRadius = '10px';
      el.style.background = 'Canvas';
      el.style.color = 'CanvasText';
      el.style.boxShadow = '0 6px 18px rgba(0,0,0,.15)';
      el.style.zIndex = '9999';
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:baseline;">
          <strong>Shortcuts</strong>
          <a href="#" id="clarity-kb-close" class="dim">close</a>
        </div>
        <div style="margin-top:8px;line-height:1.6;">
          <div><code>g</code> <code>h</code> — Home</div>
          <div><code>g</code> <code>p</code> — Projects</div>
          <div><code>g</code> <code>a</code> — Agenda</div>
          <div><code>g</code> <code>s</code> — Sync</div>
          <div><code>?</code> — Toggle this help</div>
        </div>
      `;
      document.body.appendChild(el);
      el.querySelector('#clarity-kb-close')?.addEventListener('click', (ev) => {
        ev.preventDefault();
        el.style.display = 'none';
      });
    } else {
      el.style.display = (el.style.display === 'none' ? 'block' : 'none');
    }
  };

  document.addEventListener('keydown', (ev) => {
    if (ev.defaultPrevented) return;
    if (ev.metaKey || ev.ctrlKey || ev.altKey) return;
    const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : '';
    if (tag === 'textarea' || tag === 'input') return;

    const key = (ev.key || '').toLowerCase();
    if (key === '?') {
      ev.preventDefault();
      showHelp();
      return;
    }

    const now = Date.now();
    if (awaiting && now - awaitingAt > 1000) {
      clearAwaiting();
    }

    if (!awaiting) {
      if (key === 'g') {
        ev.preventDefault();
        awaiting = 'g';
        awaitingAt = now;
      }
      return;
    }

    if (awaiting === 'g') {
      ev.preventDefault();
      clearAwaiting();
      switch (key) {
        case 'h': window.location.href = '/'; return;
        case 'p': window.location.href = '/projects'; return;
        case 'a': window.location.href = '/agenda'; return;
        case 's': window.location.href = '/sync'; return;
        default: return;
      }
    }
  }, { capture: true });
})();
</script>
{{end}}
