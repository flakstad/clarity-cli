{{define "item_main"}}
<main id="clarity-main" data-view="item">
  <div
    id="item-native"
    data-item-page
    data-item-id="{{.Item.ID}}"
    data-outline-id="{{.Item.OutlineID}}"
    data-project-id="{{.Item.ProjectID}}"
    data-can-edit="{{if .CanEdit}}true{{else}}false{{end}}"
    data-status-options='{{.StatusOptionsJSON}}'
    data-actor-options='{{.ActorOptionsJSON}}'
    data-outline-options='{{.OutlineOptionsJSON}}'
  ></div>

  <!-- Hidden form controls used by the keyboard-first JS flows (status/tags/assignee/dates/etc). -->
  <div style="display:none;">
    <input id="title" value="{{.Item.Title}}">
    <select id="status">
      <option value="" {{if eq .Item.StatusID ""}}selected{{end}}>(none)</option>
      {{range .StatusDefs}}
        <option value="{{.ID}}" {{if eq $.Item.StatusID .ID}}selected{{end}}>{{if .Label}}{{.Label}}{{else}}{{.ID}}{{end}}</option>
      {{end}}
    </select>
    <select id="assignedActorId">
      <option value="" {{if eq .AssignedID ""}}selected{{end}}>(unassigned)</option>
      {{range .ActorOptions}}
        <option value="{{.ID}}" {{if eq $.AssignedID .ID}}selected{{end}}>@{{.Label}}</option>
      {{end}}
    </select>
    <input id="tags" value="{{.TagsInput}}">
    <textarea id="description">{{.Item.Description}}</textarea>
    <input type="checkbox" name="priority" {{if .Item.Priority}}checked{{end}}>
    <input type="checkbox" name="onHold" {{if .Item.OnHold}}checked{{end}}>
    <input type="date" name="dueDate" value="{{.DueDate}}">
    <input type="time" name="dueTime" value="{{.DueTime}}">
    <input type="date" name="schDate" value="{{.SchDate}}">
    <input type="time" name="schTime" value="{{.SchTime}}">
  </div>

  {{if .Item.Archived}}
    <div class="msg"><div><strong>Archived</strong> — This item is read-only.</div></div>
  {{end}}

  <h1>{{.Item.Title}}</h1>

  <div class="card">
    <div
      class="outline-row {{if not .CanEdit}}outline-row--readonly{{end}}"
      tabindex="0"
      data-outline-row
      data-id="{{.Item.ID}}"
      data-status="{{.Item.StatusID}}"
      data-end="false"
      data-can-edit="{{if .CanEdit}}true{{else}}false{{end}}"
      data-priority="{{if .Item.Priority}}true{{else}}false{{end}}"
      data-on-hold="{{if .Item.OnHold}}true{{else}}false{{end}}"
      data-due-date="{{.DueDate}}"
      data-due-time="{{.DueTime}}"
      data-sch-date="{{.SchDate}}"
      data-sch-time="{{.SchTime}}"
      title="{{.Item.ID}}"
      style="padding: 8px 10px;"
    >
      <span class="outline-status outline-label">{{.StatusLabel}}</span>
      <span class="outline-title outline-text">{{.Item.Title}}</span>
      <span class="outline-right">
        {{if .Item.Priority}}<span class="outline-flag outline-flag--priority">P</span>{{end}}
        {{if .Item.OnHold}}<span class="outline-flag outline-flag--hold">H</span>{{end}}
        {{if .Item.Due}}<span class="outline-meta outline-meta--due outline-due dim">Due {{.DueDate}}{{if .DueTime}} {{.DueTime}}{{end}}</span>{{end}}
        {{if .Item.Schedule}}<span class="outline-meta outline-meta--sch outline-schedule dim">Sch {{.SchDate}}{{if .SchTime}} {{.SchTime}}{{end}}</span>{{end}}
        {{if .AssignedLabel}}<span class="outline-assignee outline-assign dim">@{{.AssignedLabel}}</span>{{end}}
        {{if .Item.Tags}}<span class="outline-tags dim">{{range $i, $t := .Item.Tags}}{{if $i}} {{end}}#{{$t}}{{end}}</span>{{end}}
      </span>
    </div>
    <div class="dim" style="margin-top: 10px;">
      Item <code>{{.Item.ID}}</code> · Outline <code>{{.Item.OutlineID}}</code> · Owner <code>{{.Item.OwnerActorID}}</code>{{if .Item.ParentID}} · Parent <code>{{.Item.ParentID}}</code>{{end}}
    </div>
    <div id="outline-status" class="dim" style="margin-top: 10px;"></div>
  </div>

  {{if .SuccessMessage}}
    <div class="msg"><div><strong>OK</strong> — {{.SuccessMessage}}</div></div>
  {{end}}
  {{if .ErrorMessage}}
    <div class="err"><div><strong>Error</strong> — {{.ErrorMessage}}</div></div>
  {{end}}

  <div class="card">
    <div><strong>Description</strong></div>
    {{if .Item.Description}}<pre>{{.Item.Description}}</pre>{{else}}<div>(none)</div>{{end}}
  </div>

  <div class="card">
    <div><strong>Comments</strong> ({{len .Comments}})</div>
    {{if and (not .ReadOnly) .ActorID}}
      <form id="comment-form" method="post" action="/items/{{.Item.ID}}/comments" style="margin-top: 12px;">
        {{if .ReplyTo}}
          <div class="dim">Replying to <code>{{.ReplyTo}}</code> — <a href="/items/{{.Item.ID}}#comment-form">cancel</a></div>
          <input type="hidden" name="replyTo" value="{{.ReplyTo}}">
        {{end}}
        <div><label for="body"><span class="dim">Add comment</span></label></div>
        <div><textarea id="body" name="body" rows="4" style="width: 100%; max-width: 100%;"></textarea></div>
        <div style="margin-top: 8px;"><button type="submit">Post</button></div>
      </form>
    {{end}}
    {{if .Comments}}
      <ul>
        {{range .Comments}}
          <li>
            <span class="dim">{{.CreatedAt.Format "2006-01-02 15:04:05Z07:00"}}</span>
            — <code>{{.AuthorID}}</code>
            {{if .ReplyToCommentID}} <span class="dim">(reply to <code>{{.ReplyToCommentID}}</code>)</span>{{end}}
            {{if and (not $.ReadOnly) $.ActorID}} <span class="dim">— <a href="/items/{{$.Item.ID}}?replyTo={{.ID}}#comment-form">reply</a></span>{{end}}
            <pre>{{.Body}}</pre>
          </li>
        {{end}}
      </ul>
    {{else}}
      <div>(none)</div>
    {{end}}
  </div>

  <div class="card">
    <div><strong>Worklog</strong> (private)</div>
    {{if and (not .ReadOnly) .ActorID}}
      <form id="worklog-form" method="post" action="/items/{{.Item.ID}}/worklog" style="margin-top: 12px;">
        <div><label for="worklog"><span class="dim">Add worklog entry (only visible to you)</span></label></div>
        <div><textarea id="worklog" name="body" rows="4" style="width: 100%; max-width: 100%;"></textarea></div>
        <div style="margin-top: 8px;"><button type="submit">Add</button></div>
      </form>
    {{end}}
    {{if .Worklog}}
      <ul>
        {{range .Worklog}}
          <li>
            <span class="dim">{{.CreatedAt.Format "2006-01-02 15:04:05Z07:00"}}</span>
            <pre>{{.Body}}</pre>
          </li>
        {{end}}
      </ul>
    {{else}}
      <div class="dim">(none)</div>
    {{end}}
  </div>
</main>
{{end}}

{{define "item.html"}}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Clarity Web – Item</title>
  <link rel="stylesheet" href="/static/themes.css">
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
  {{template "web_header" .}}
  {{template "item_main" .}}
  {{template "web_scripts" .}}
</body>
</html>
{{end}}
